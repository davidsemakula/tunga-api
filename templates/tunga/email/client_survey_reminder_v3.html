{% extends "tunga/email/content.html" %}
{% load i18n %}
{% block email_header %}
    Let us know about your experience on Tunga for your project.
{% endblock %}
{% block email_content %}
    <p>Hi {{ owner.first_name }},</p>

    <p>Please fill in this weekly survey to report on your Tunga project: {{ event.project.title }}.<br/>

    It is very important that you complete this survey within 48 hours and it will take you less than a minute.<br/>

    Why? It helps us to monitor and improve the quality of our service for you. And to take direct action where desirable.
    </p>

    <style>
        svg {
            height: 3.6rem;
            width: 3.6rem;
            margin: 0.2rem;
        }

        input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        input[type="radio"] + svg {
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }

        input + svg{
            cursor: pointer;
        }

        input[type="radio"]:hover + svg g,
        input[type="radio"]:checked + svg g,
        input[type="radio"]:focus + svg g{
            fill: #da3451 !important;
        }

        .btn {
            font-size: .76562rem;
            font-weight: 300;
            padding-top: 0!important;
            padding-bottom: 0!important;
            line-height: 2.5rem;
            height: 2.5rem;
        }

        .btn-primary {
            color: #fff;
            background-color: #da3451;
            border-color: #da3451;
            box-shadow: 2px 2px 3px 0 rgba(68,68,68,.8);
        }
    </style>

    <form id="myForm" action="https://example.com">
        <input type="hidden" id="eventId" name="event" value="{{event.id}}">

        {% for participant in participants %}
            <h4>How would you rate the collaboration with {{ participant.user }} for {{ project }}?</h4>
            <input type="hidden" class="userIds" name="userId-{{participant.user.id}}" value="{{participant.user.id}}">
            <div class="survey__icons">
                <label><input type="radio" name="rating-{{participant.user.id}}" value="1"/> {% include "tunga/icons/simley1.html" %}</label>
                <label><input type="radio" name="rating-{{participant.user.id}}" value="2"/> {% include "tunga/icons/simley2.html" %}</label>
                <label><input type="radio" name="rating-{{participant.user.id}}" value="3"/> {% include "tunga/icons/simley3.html" %}</label>
                <label><input type="radio" name="rating-{{participant.user.id}}" value="4"/> {% include "tunga/icons/simley4.html" %}</label>
                <label><input type="radio" name="rating-{{participant.user.id}}" value="5"/> {% include "tunga/icons/simley5.html" %}</label>
            </div>
        {% endfor %}

        <div class="survey__btn-wrapper">
            <button type="submit" class="btn btn-primary">Submit Rating</button>
        </div>

    </form>

    <script type="text/javascript">
        var form = document.getElementById("myForm");
        function handleForm(event) {
            event.preventDefault();

            var ratings = [];
            var rating = 0;

            var userIdElements = document.querySelectorAll("input[class=userIds]");
            for (index = 0; index < userIdElements.length; ++index) {
                if(document.querySelector('input[name="rating-'+userIdElements[index].value+'"]:checked')){
                  var rating = document.querySelector('input[name="rating-'+userIdElements[index].value+'"]:checked').value;
                  ratings.push({user: userIdElements[index].value, rating: rating})
                }

            }

            var event = { "id" : document.querySelector('input[name="event"]').value } // this is the id of the this project progress event
            var user = 2 // this should be the client email to whom you are sending the email

            var http = new XMLHttpRequest();
            var url = '/api/developer-rating/';

            ratings.forEach(element => {
              console.log(element)
              var params = {
                event: event,
                rating: element.rating,
                user: element.user
              }
              http.open('POST', url, true);

              //Send the proper header information along with the request
              http.setRequestHeader('Content-type', 'application/json;charset=UTF-8');

              http.onreadystatechange = function() {//Call a function when the state changes.
                  if(http.readyState == 4 && http.status == 200) {
                      alert(http.responseText);
                      console.log('working perfectly well')
                  }else{
                      console.log('failed to send data')
                  }
              }
              http.send(JSON.stringify(params));
            });


        }
        form.addEventListener('submit', handleForm);
    </script>

    <p>
        Click the link below to complete the survey:<br/>
        <a href="{{ update_url }}">{{ update_url }}</a>
    </p>
{% endblock %}
